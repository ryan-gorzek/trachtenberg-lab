---
title: "R Notebook"
output: html_notebook
---

```{r}

library(Seurat)
library(SeuratDisk)
library(reticulate)
library(scrubletR)
library(ggplot2)
library(patchwork)
library(dplyr)
library(data.table)
library(clustree)
library(reshape2)
library(tidyr)
library(gridExtra)
library(stringr)
library(plyr)
source("C:/Ryan/GitHub/trachtenberg-lab/transcriptomics/tools/seurat_functions.R")
source("C:/Ryan/GitHub/trachtenberg-lab/transcriptomics/tools/seurat_integration_functions.R")
source("C:/Ryan/GitHub/trachtenberg-lab/transcriptomics/xgboost/xgboost_train.R")
source("C:/Ryan/GitHub/trachtenberg-lab/transcriptomics/xgboost/plottingFxns.R")
colors_list <- GetColors()

obj.i.mouse <- readRDS("E:/STOmics/seurat/Mouse/mouse_stereoseq_ctx_COLs_integrated.rds")
obj.i.opossum <- readRDS("E:/STOmics/seurat/Opossum/opossum_stereoseq_ctx_COLs_integrated.rds")

```


```{r}

IT.sn.names <- colnames(obj.i.mouse)[obj.i.mouse$subclass %in% c("L2/3", "L4", "L5IT")]
IT.sp.names <- colnames(obj.i.mouse)[obj.i.mouse$subclass_nn %in% c("L2/3", "L4", "L5IT")]
obj.i.mouse.IT <- obj.i.mouse[, c(IT.sn.names, IT.sp.names)]

IT.sn.names <- colnames(obj.i.opossum)[obj.i.opossum$subclass %in% c("IT_A", "IT_B", "IT_C")]
IT.sp.names <- colnames(obj.i.opossum)[obj.i.opossum$subclass_nn %in% c("IT_A", "IT_B", "IT_C")]
obj.i.opossum.IT <- obj.i.opossum[, c(IT.sn.names, IT.sp.names)]

```


```{r}

obj.i.mouse.IT <- RunPCA(obj.i.mouse.IT)
obj.i.opossum.IT <- RunPCA(obj.i.opossum.IT)

```


```{r}

subclasses.mouse <- c("L2/3", "L4", "L5IT", "None")
Idents(obj.i.mouse.IT) <- "subclass"
DimPlot(obj.i.mouse.IT, reduction = "pca", dims = c(2, 3), cols = colors_list[subclasses.mouse], label = TRUE) + NoLegend() + xlim(-30, 25) + ylim(-20, 35) + coord_equal()
df <- data.frame(cell = colnames(obj.i.mouse.IT), method = obj.i.mouse.IT$method, X = obj.i.mouse.IT@reductions$pca@cell.embeddings[, 2], Y = obj.i.mouse.IT@reductions$pca@cell.embeddings[, 3])
write.csv(df, "E:/Opossum_Paper/Figure 3/mouse_triangle_integrated.csv", row.names = FALSE)

Idents(obj.i.mouse.IT) <- "subclass_nn"
p <- DimPlot(obj.i.mouse.IT, reduction = "pca", dims = c(2, 3), cols = colors_list[subclasses.mouse], label = TRUE) + NoLegend() + xlim(-30, 25) + ylim(-20, 35) + coord_equal()
ggsave("E:/Opossum_Paper/Figure 3/mouse_pc_gradient_methods.svg", plot = p)

```


```{r}

subclasses.opossum <- c("IT_A", "IT_B", "IT_C", "None")
Idents(obj.i.opossum.IT) <- "subclass"
DimPlot(obj.i.opossum.IT, reduction = "pca", dims = c(2, 3), cols = colors_list[subclasses.opossum], label = TRUE) + NoLegend() + xlim(-30, 35) + ylim(-30, 35) + coord_equal()
df <- data.frame(cell = colnames(obj.i.opossum.IT), method = obj.i.opossum.IT$method, X = obj.i.opossum.IT@reductions$pca@cell.embeddings[, 2], Y = obj.i.opossum.IT@reductions$pca@cell.embeddings[, 3])
write.csv(df, "E:/Opossum_Paper/Figure 3/opossum_triangle_integrated.csv", row.names = FALSE)

Idents(obj.i.opossum.IT) <- "subclass_nn"
p <- DimPlot(obj.i.opossum.IT, reduction = "pca", dims = c(2, 3), cols = colors_list[subclasses.opossum], label = TRUE) + NoLegend() + xlim(-30, 35) + ylim(-30, 35) + coord_equal()
ggsave("E:/Opossum_Paper/Figure 3/opossum_pc_gradient_methods.svg", plot = p)

```


```{r}

DimPlotGradient <- function(obj, rgb_csv, pc1 = "PC_2", pc2 = "PC_3", size = 2) {
  
  # Load RGB colors from CSV
  rgb_data <- read.csv(rgb_csv, row.names = 1)
  
  # Extract PC coordinates from the Seurat object
  pc_coords <- Embeddings(obj, reduction = "pca")[, c(pc1, pc2)]
  
  # Create dataframe
  df <- data.frame(PC1 = pc_coords[, 1], PC2 = pc_coords[, 2], cells = rownames(pc_coords))
  
  # Merge colors with PC coordinates
  df <- merge(df, rgb_data, by.x = "cells", by.y = "row.names", all.x = TRUE)
  df <- df[!is.na(df$R), ]
  
  # Ensure RGB values are within range [0,1]
  df$R <- pmax(0, pmin(1, df$R))
  df$G <- pmax(0, pmin(1, df$G))
  df$B <- pmax(0, pmin(1, df$B))
  
  # Convert RGB to hex color codes
  df$hex_color <- with(df, rgb(R, G, B, maxColorValue = 1))
  
  # Reorder points for proper layering
  df <<- df[order(df$R + df$G + df$B, decreasing = FALSE), ]
  
  # Generate scatter plot
  p <- ggplot(df, aes(x = PC1, y = PC2, color = hex_color)) +
    geom_point(shape = 19, size = size, alpha = 1) +
    scale_color_identity() +  # Directly use hex colors, no legend
    theme_minimal() +
    theme(axis.text = element_blank(), axis.ticks = element_blank()) +
    guides(color = "none") +  # Remove color legend
    coord_equal()
  
  return(p)
}

p <- DimPlotGradient(obj = obj.i.mouse.IT, rgb_csv = "E:/Opossum_Paper/Figure 3/mouse_integrated_PC_colors.csv")
ggsave("E:/Opossum_Paper/Figure 3/mouse_stereoseq_pc_gradient.svg", plot = p)

p <- DimPlotGradient(obj = obj.i.opossum.IT, rgb_csv = "E:/Opossum_Paper/Figure 3/opossum_integrated_PC_colors.csv")
ggsave("E:/Opossum_Paper/Figure 3/opossum_stereoseq_pc_gradient.svg", plot = p)

```


```{r}

mouse.path = "E:/Opossum_Paper/Figure 3/mouse_integrated_PC_colors.csv"

ImageDimPlotGradient(obj = obj.i.mouse.IT, rgb_csv = mouse.path, yticks = c(0, 500, 1000, 1500)) + coord_fixed(ratio = 1.5)

obj.i.mouse.IT.L23 <- subset(obj.i.mouse.IT, subclass_nn == "L2/3")
p <- ImageDimPlotGradient(obj = obj.i.mouse.IT.L23, rgb_csv = mouse.path, yticks = c(0, 500, 1000, 1500)) + coord_fixed(ratio = 1.5)
ggsave("E:/Opossum_Paper/Figure 3/mouse_stereoseq_pc_gradient_spatial_L23.svg", plot = p)

obj.i.mouse.IT.L4 <- subset(obj.i.mouse.IT, subclass_nn == "L4")
p <- ImageDimPlotGradient(obj = obj.i.mouse.IT.L4, rgb_csv = mouse.path, yticks = c(0, 500, 1000, 1500)) + coord_fixed(ratio = 1.5)
ggsave("E:/Opossum_Paper/Figure 3/mouse_stereoseq_pc_gradient_spatial_L4.svg", plot = p)

obj.i.mouse.IT.L5IT <- subset(obj.i.mouse.IT, subclass_nn == "L5IT")
p <- ImageDimPlotGradient(obj = obj.i.mouse.IT.L5IT, rgb_csv = mouse.path, yticks = c(0, 500, 1000, 1500)) + coord_fixed(ratio = 1.5)
ggsave("E:/Opossum_Paper/Figure 3/mouse_stereoseq_pc_gradient_spatial_L5IT.svg", plot = p)

```


```{r}

opossum.path <- "E:/Opossum_Paper/Figure 3/opossum_integrated_PC_colors.csv"

ImageDimPlotGradient(obj = obj.i.opossum.IT, rgb_csv = opossum.path, yticks = c(0, 400, 800, 1200, 1600)) + coord_fixed(ratio = 0.77*1.5)

obj.i.opossum.IT.A <- subset(obj.i.opossum.IT, subclass_nn == "IT_A")
p <- ImageDimPlotGradient(obj = obj.i.opossum.IT.A, rgb_csv = opossum.path, yticks = c(0, 400, 800, 1200, 1600)) + coord_fixed(ratio = 0.77*1.5) + ylim(4.278372, 1545.594104)
ggsave("E:/Opossum_Paper/Figure 3/opossum_stereoseq_pc_gradient_spatial_A.svg", plot = p)

obj.i.opossum.IT.B <- subset(obj.i.opossum.IT, subclass_nn == "IT_B")
p <- ImageDimPlotGradient(obj = obj.i.opossum.IT.B, rgb_csv = opossum.path, yticks = c(0, 400, 800, 1200, 1600)) + coord_fixed(ratio = 0.77*1.5) + ylim(4.278372, 1545.594104)
ggsave("E:/Opossum_Paper/Figure 3/opossum_stereoseq_pc_gradient_spatial_B.svg", plot = p)

obj.i.opossum.IT.C <- subset(obj.i.opossum.IT, subclass_nn == "IT_C")
p <- ImageDimPlotGradient(obj = obj.i.opossum.IT.C, rgb_csv = opossum.path, yticks = c(0, 400, 800, 1200, 1600)) + coord_fixed(ratio = 0.77*1.5) + ylim(4.278372, 1545.594104)
ggsave("E:/Opossum_Paper/Figure 3/opossum_stereoseq_pc_gradient_spatial_C.svg", plot = p)

```


```{r}

mouse.path = "E:/Opossum_Paper/Figure 3/mouse_integrated_PC_colors.csv"
data.mouse <- read.csv(mouse.path, row.names = 1)

opossum.path = "E:/Opossum_Paper/Figure 3/opossum_integrated_PC_colors.csv"
data.opossum <- read.csv(opossum.path, row.names = 1)


```


```{r}

# Define subclass pairs
subclass_pairs <- list(
  "L2/3" = c("IT_A", "A"),
  "L4"   = c("IT_B", "B"),
  "L5IT" = c("IT_C", "C")
)

# Loop over subclass pairs
for (mouse_subclass in names(subclass_pairs)) {
  
  opossum_subclass <- subclass_pairs[[mouse_subclass]][1]
  vertex <- paste0("Distance_to_Vertex_", subclass_pairs[[mouse_subclass]][2])
  
  # Subset mouse cells
  mouse_cells <- colnames(obj.i.mouse.IT)[!is.na(obj.i.mouse.IT$subclass_nn) & obj.i.mouse.IT$subclass_nn == mouse_subclass]
  
  mouse_coords <- obj.i.mouse.IT@images[[1]]$centroids@coords[obj.i.mouse.IT$subclass_nn[!is.na(obj.i.mouse.IT$subclass_nn)] == mouse_subclass,]
  rownames(mouse_coords) <- mouse_cells
  mouse_y_positions <- mouse_coords[mouse_cells, "x"]
  mouse_distance <- data.mouse[mouse_cells, vertex]

  # Subset opossum cells
  opossum_cells <- colnames(obj.i.opossum.IT)[!is.na(obj.i.opossum.IT$subclass_nn) & obj.i.opossum.IT$subclass_nn == opossum_subclass]
  opossum_coords <- obj.i.opossum.IT@images[[1]]$centroids@coords[obj.i.opossum.IT$subclass_nn[!is.na(obj.i.opossum.IT$subclass_nn)] == opossum_subclass,]
  rownames(opossum_coords) <- opossum_cells
  opossum_y_positions <- opossum_coords[opossum_cells, "x"]
  opossum_distance <- data.opossum[opossum_cells, vertex]

  # Combine data into one dataframe
  df_combined <- data.frame(
    Y_Position = c(mouse_y_positions, opossum_y_positions),
    Distance_to_Vertex_A = c(mouse_distance, opossum_distance),
    Species = c(rep("Mouse", length(mouse_y_positions)),
                rep("Opossum", length(opossum_y_positions)))
  )

  # Compute correlation per species
  mouse_cor <- cor.test(mouse_y_positions, mouse_distance)
  opossum_cor <- cor.test(opossum_y_positions, opossum_distance)

  # Scatterplot comparing mouse vs opossum
  plot_title <- sprintf("Y Position vs. Distance (Mouse: %s, Opossum: %s)", mouse_subclass, opossum_subclass)

  p <- ggplot(df_combined, aes(x = Y_Position, y = Distance_to_Vertex_A, color = Species)) +
    geom_point(alpha = 1, size = 1.5) +
    geom_smooth(method = "lm", se = TRUE) +
    labs(
      title = plot_title,
      subtitle = sprintf("Correlation - Mouse (r=%.2f, p=%.3g), Opossum (r=%.2f, p=%.3g)",
                         mouse_cor$estimate, mouse_cor$p.value,
                         opossum_cor$estimate, opossum_cor$p.value),
      x = "Y Spatial Position",
      y = vertex
    ) +
    theme_bw(base_size = 14) +
    ylim(0, 1) + xlim(0, 1500) + #  + coord_fixed(ratio = 35) +
    scale_color_manual(values = c("Opossum" = "#c692b8", "Mouse" = "#aaaaaa"))

  print(p)
  # ggsave(paste0("E:/Opossum_Paper/Figure 3/Corr_Y_Vertex_", opossum_subclass, ".svg"), plot = p)
}

```





```{r}

# Ensure your cell identifiers match between the Seurat object and the dataframe
common.cells <- intersect(colnames(obj.i.opossum.IT.A), rownames(data.opossum))

# Extract Y spatial position from Seurat object
coords <- obj.i.opossum.IT.A@images[[1]]$centroids@coords
rownames(coords) <- colnames(obj.i.opossum.IT.A)
y_positions <- coords[common.cells, "x"]

# Extract Distance_to_Vertex_A from dataframe
distance_to_vertex <- data.opossum[common.cells, "Distance_to_Vertex_A"]

# Compute correlation
correlation_result <- cor.test(y_positions, distance_to_vertex, method = "pearson")

# Display results
print(correlation_result)

df_plot <- data.frame(
  Y_Position = y_positions,
  Distance_to_Vertex_A = distance_to_vertex
)

ggplot(df_plot, aes(x = Y_Position, y = Distance_to_Vertex_A)) +
  geom_point(alpha = 0.7, size = 1.5, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = sprintf("Correlation: r = %.3f, p = %.3g",
                    correlation_result$estimate, correlation_result$p.value),
    x = "Y Spatial Position",
    y = "Distance to Vertex A"
  ) +
  theme_bw(base_size = 14)

```




















